<html>

<head>
  <title>Scan</title>
  <script src="jquery.js"></script>
  <script src="init.js"></script>
  <script src="csvjquery.js"></script>
  <script src="download.js"></script>
  <link rel="stylesheet" href="bootstrap-switch.min.css">
  <script src="bootstrap-switch.min.js"></script>
  <script type="text/javascript">
    var readings_red_path = "readings_red.csv";
    var readings_green_path = "readings_green.csv"
    $("document").ready(function() {
      //showAllCookies();
      $("#csv-toggle").bootstrapSwitch("onText", "GREEN");
      $("#csv-toggle").bootstrapSwitch("onColor","success");
      $("#csv-toggle").bootstrapSwitch("offText","RED");
      $("#csv-toggle").bootstrapSwitch("offColor","danger");
      $("#csv-toggle").bootstrapSwitch("labelText","CSV");

      $("#modeselect").val(getCookie("welltype"));

      $("#modeselect").change(function() {
        var select = document.getElementById("modeselect");
        var mode = select.options[select.selectedIndex].value;
        setCookie("welltype", mode, 365);
      });

      $("#csvselect").change(function() {
        paintWell();
      });

      $("#download").click(function() {
        if (!$(this).disabled) {
          if($("#csv-toggle").bootstrapSwitch("state")){
            download(loadDocument(readings_green_path,false), readings_green_path, "CSV");
          }else{
            download(loadDocument(readings_red_path,false), readings_red_path, "CSV");
          }
        }
      });

      //Whoa, there's a lot going on in this here!
      //The following code executes when the Button with the .scan class is pressed. Basically the Scan button.
      //It then changes the text to "Running" and disables the button, furthermore it gets the welltype out of the select box
      //and sends this via an ajax command to the esp.
      //On success it reenables the button and also enables the download button, if disabled that is.
      //On failure it reenables the scan button, but not the download Button.
      $(".scan").click(function() {
        //console.log("scan!");
        document.getElementById("reading").innerHTML = "SCANNING";
        document.getElementById("reading").disabled = true;
        var select = document.getElementById("modeselect");
        var mode = select.options[select.selectedIndex].value;
        $.getJSON('ajax/read', {
          mode: mode
        }, function(data) {
          //console.log("Scan command");
        }).fail(function() {
          document.getElementById("reading").innerHTML = "&nbsp&nbspSCAN&nbsp&nbsp";
          document.getElementById("reading").disabled = false;
          console.log("Error");
        }).done(function() {
          document.getElementById("reading").innerHTML = "&nbsp&nbspSCAN&nbsp&nbsp";
          document.getElementById("reading").disabled = false;
          document.getElementById("download").disabled = false;
          console.log("success");
          paintWell();
        });
      });
    });
  </script>
  <script type="text/javascript">
    ///
    Well = {

        init: function(canvasId, type) {
          this.setType(type);
          this.setCanvas(canvasId);
        },
        setCanvas: function(canvasId) {
          this.canvasElement = document.getElementById(canvasId);
          this.canvas = this.canvasElement.getContext("2d");
          this.canvas.lineWidth = 2;
          this.height = this.canvasElement.height;
          this.width = this.canvasElement.width;
          this.x = 10;
          this.y = 10;
          this.reference = parseInt(getCookie("wellreference"));
          this.xs = this.canvasElement.width - 10;
          this.ys = this.canvasElement.height - 10;
        },
        setDimension: function(x, y, xs, ys) {
          this.x = x;
          this.xs = xs;
          this.y = y;
          this.ys = ys;
        },
        getDimension: function() {
          return [this.x, this.y, this.xs, this.ys];
        },
        setType: function(type) {
          if (type == 6) {
            this.rows = 2;
            this.columns = 3;
          } else if (type == 96) {
            this.rows = 8;
            this.columns = 12;
          }
        },
        getType: function() {
          return [this.rows, this.columns];
        },
        setData: function(dataset) {
          this.dataset = dataset;
          console.log(dataset);
        },
        getRandom: function(min, max) {
          return Math.floor(Math.random() * (max - min + 1)) + min;
        },
        fadeOut: function(time) {
          $(this.canvasElement).fadeOut(time);
        },
        fadeIn: function(time) {
          $(this.canvasElement).fadeIn(time);
        },
        hide: function() {
          $(this.canvasElement).hide(0);
        },
        clear: function(fadeouttime) {
          var fadeouttime = fadeouttime || 0
          this.fadeOut(0);
          this.canvas.clearRect(0, 0, this.width, this.height);
        },
        paint: function() {
          this.hide();
          this.canvas.beginPath();
          this.canvas.moveTo(this.x + 20, this.y);
          this.canvas.lineTo(this.x + this.xs, this.y);
          this.canvas.lineTo(this.x + this.xs, this.y + this.ys);
          this.canvas.lineTo(this.x + 20, this.y + this.ys);
          this.canvas.lineTo(this.x, this.y + this.ys - 20);
          this.canvas.lineTo(this.x, this.y + 20);
          this.canvas.closePath();
          this.canvas.fillStyle = "rgba(250, 250, 250, .70)";
          this.canvas.fill();
          this.canvas.stroke();

          //this.canvas.fillStyle = "black";

          //console.log(this.dataset);
          for (j = 1; j <= this.rows; j++) {
            this.canvas.fillStyle = "black";
            this.canvas.fillText(this.dataset[j + 1][0], 0, (this.ys - this.y) / this.rows * j + 3);
            //console.log(this.dataset[j+1][0]);
            for (i = 1; i <= this.columns; i++) {
              //console.log("Drawing well " + w);
              this.canvas.beginPath();
              var factor = this.reference / 255;
              var r = (this.ys - this.y) / (this.rows * 2.3);
              var x = (this.xs - this.x) / this.columns * i - r / 4;
              var y = (this.ys - this.y) / this.rows * j - r / 4;
              this.canvas.arc(x, y, r, 0, 2 * Math.PI);
              var shade = this.dataset[j + 1][i];
              //console.log("Shade: " + shade/factor);
              this.canvas.fillStyle = "rgba(" + Math.round(shade / factor) + ",0," + Math.round(shade / factor) + ",0.5)";
              this.canvas.fill();
              this.canvas.fillStyle = "white";
              var pT = Math.round((shade * 100 / this.reference)) + "%";
              this.canvas.fillText(pT, x - (pT.length * 3), y + 2);
              this.canvas.fillStyle = "black";
              this.canvas.fillText(this.dataset[1][i], x - (this.dataset[1][i].length * 3), 8);
              this.canvas.stroke();
            }
          }
          //this.canvas.beginPath();
          //  this.canvas.fillText("Well",100,150);

          this.fadeIn(500);
        }
      }
      ///
    function paintWell(dataset) {
      well.clear();
      well.paint();
    }
    $("document").ready(function() {
      well = Well;
      well.init("wellCanvas", 96);
      //console.log(well.getType());
      //var reading = document.getElementById("csvselect");
      //var csvDoc = reading.options[reading.selectedIndex].value;
      if (UrlExists(readings_red_path)) {
        document.getElementById("download").disabled = false;
        well.setData($.csv.toArrays(loadDocument(readings_red_path)), false);
        paintWell();
      }

      $("#csv-toggle").bootstrapSwitch("onSwitchChange", function() {
        if (UrlExists(readings_red_path) && UrlExists(readings_green_path)) {
          if ($(this).bootstrapSwitch("state")) {
            well.setData($.csv.toArrays(loadDocument(readings_green_path)), false);
          } else {
            well.setData($.csv.toArrays(loadDocument(readings_red_path)), false);
          }
          paintWell();
        }
      });
    });
  </script>
</head>

<body active="SCAN">
  <noscript>This software uses Javascript! Please enable for correct functionality</noscript>

  <div id="navbar"></div>

  <!-- Define Background Style Wrapper
  <div id="wrapper" style="text-align: center;">
    <div class="circle-container blur">
      <div class="circle"></div>
      <div class="circle"></div>
      <div class="circle"></div>
      <div class="circle"></div>
      <div class="circle"></div>
    </div>
  </div>
  -->

  <div id="secret" style="display:none"></div>

  <div>
    <table class="glasspanel fTable" style="font-family:Timeburner;text-align:center;z-index:100;margin:auto;margin-top:2%;">
      <tr>
        <td>
          <button id="reading" class="btn btn-success btn-xlg btn-block scan">&nbsp&nbspSCAN&nbsp&nbsp</button>
        </td>
        <td>
          <select id="modeselect" class="form-control input-lg">
            <!--<option value="6">6-Well</option>-->
            <option value="96">96-Well</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>
          <button id="download" value="96" class="btn btn-warning btn-xlg btn-block csv" disabled>DOWNLOAD CSV</button>
        </td>
        <td>
          <!--
          <select id="csvselect" class="form-control input-lg">
            <option value="readings_red.csv">RED</option>
            <option value="readings_green.csv">GREEN</option>
          </select>
        -->
          <input id="csv-toggle" type="checkbox">
        </td>
      </tr>
    </table>
    <!--<button id="redraw" class="btn btn-lg btn-warning" style="margin-left:auto;margin-right:auto;display:block;margin-top:1%">Redraw</button>-->
    <canvas id="wellCanvas" height="348" width="516" style="margin-left:auto;margin-right:auto;display:block">
  </div>
</body>

</html>
